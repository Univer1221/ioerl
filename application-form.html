<div class="container-fluid animate-fade-in py-2">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom py-2">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary font-weight-bold">
                    {{isEdit ? 'Edit Application' : 'New Application'}}
                </h5>
                <a routerLink="/Admin/Application/List" class="btn btn-outline-primary btn-xs shadow-sm px-2 font-weight-bold">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
            </div>
        </div>
        <div class="card-body p-3">
            <form (ngSubmit)="onSubmit()" #appForm="ngForm">
                <div class="row g-2">
                    <!-- Basic Information Section -->
                    <div class="col-12 border-bottom pb-1 mb-1">
                        <h6 class="text-secondary font-weight-bold smallest mb-0"><i class="fas fa-info-circle me-2 info-icon-small"></i>BASIC INFORMATION</h6>
                    </div>

                    <div class="col-md-6 mb-1">
                        <label class="smallest font-weight-bold text-dark mb-1">Application Name</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="fas fa-desktop"></i></span>
                            <input type="text" name="appName" [(ngModel)]="appData.appName" class="form-control form-control-sm" placeholder="Enter app name" required />
                        </div>
                    </div>

                    <div class="col-md-6 mb-1">
                        <label class="smallest font-weight-bold text-dark mb-1">Application Owner</label>
                        <div class="search-field-wrapper">
                            <ng-select [items]="adUsers"
                                       bindLabel="displayName"
                                       [(ngModel)]="selectedAdUser"
                                       name="appOwnerSelect"
                                       placeholder="Search or type owner name..."
                                       [clearable]="true"
                                       [addTag]="addCustomOwner"
                                       [addTagText]="'Use this name'"
                                       (search)="onOwnerSearch($event.term)"
                                       (change)="onAdUserSelect($event)"
                                       (clear)="onAdUserClear()"
                                       class="custom-ng-select-sm"
                                       required>
                            <ng-template ng-option-tmp let-item="item">
                                <div class="d-flex align-items-center">
                                    <img *ngIf="item.photoUrl" [src]="item.photoUrl" class="rounded-circle me-2" width="28" height="28" />
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">{{item.displayName}}</span>
                                        <small class="text-muted" *ngIf="item.mail">{{item.mail}}</small>
                                    </div>
                                </div>
                            </ng-template>
                            <ng-template ng-label-tmp let-item="item">
                                <span>{{item.displayName}}</span>
                            </ng-template>
                            </ng-select>
                            <span *ngIf="adUserLoading" class="loader-inline"><i class="fas fa-spinner fa-spin"></i></span>
                        </div>
                        <input type="hidden" name="appOwner" [(ngModel)]="appData.appOwner" required />
                    </div>

                    <div class="col-md-6 mb-1">
                        <label class="smallest font-weight-bold text-dark mb-1">Owner Email (Credentials Recipient)</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="fas fa-at"></i></span>
                            <input type="email" name="ownerEmail" [(ngModel)]="appData.ownerEmail" class="form-control form-control-sm" placeholder="owner@example.com" required email />
                        </div>
                    </div>

                    <div class="col-md-6 mb-1">
                        <label class="smallest font-weight-bold text-dark mb-1">Co-Owner (Optional)</label>
                        <div class="search-field-wrapper">
                            <ng-select [items]="coOwnerAdUsers"
                                       bindLabel="displayName"
                                       [(ngModel)]="selectedCoOwner"
                                       name="coOwnerSelect"
                                       placeholder="Search co-owner..."
                                       [clearable]="true"
                                       [addTag]="addCustomOwner"
                                       [addTagText]="'Use this name'"
                                       (search)="onCoOwnerSearch($event.term)"
                                       (change)="onCoOwnerSelect($event)"
                                       (clear)="onCoOwnerClear()"
                                       class="custom-ng-select-sm">
                            <ng-template ng-option-tmp let-item="item">
                                <div class="d-flex align-items-center">
                                    <img *ngIf="item.photoUrl" [src]="item.photoUrl" class="rounded-circle me-2" width="28" height="28" />
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">{{item.displayName}}</span>
                                        <small class="text-muted" *ngIf="item.mail">{{item.mail}}</small>
                                    </div>
                                </div>
                            </ng-template>
                            <ng-template ng-label-tmp let-item="item">
                                <span>{{item.displayName}}</span>
                            </ng-template>
                            </ng-select>
                            <span *ngIf="coOwnerLoading" class="loader-inline"><i class="fas fa-spinner fa-spin"></i></span>
                        </div>
                        <input type="hidden" name="coOwner" [(ngModel)]="appData.coOwner" />
                    </div>

                    <div class="col-md-6 mb-1">
                        <label class="smallest font-weight-bold text-dark mb-1">Co-Owner Email (Optional)</label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light"><i class="fas fa-at"></i></span>
                            <input type="email" name="coOwnerEmail" [(ngModel)]="appData.coOwnerEmail" class="form-control form-control-sm" placeholder="coowner@example.com" email />
                        </div>
                    </div>

                    <div class="col-12 mb-1">
                        <label class="smallest font-weight-bold text-dark mb-1">Description</label>
                        <textarea name="description" [(ngModel)]="appData.description" class="form-control form-control-sm" rows="1" placeholder="Briefly describe the application" required></textarea>
                    </div>

                    <!-- Email Configuration Section -->
                    <div class="col-12 border-bottom pb-1 mb-1 mt-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="text-secondary mb-0 font-weight-bold smallest"><i class="fas fa-cog me-2"></i>CONFIGURATION & EMAIL SETTINGS</h6>
                            <span class="badge bg-light text-primary border smallest" *ngIf="!isTPInternal()"><i class="fas fa-shield-alt me-1"></i>Secure Runtime Auth</span>
                            <span class="badge bg-success text-white border smallest" *ngIf="isTPInternal()"><i class="fas fa-check-circle me-1"></i>Managed by Backend</span>
                        </div>
                    </div>

                    <div class="col-12 mb-1" *ngIf="!isTPInternal()">
                        <div class="alert alert-info border-0 shadow-sm smallest mb-0 py-1">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> <strong>From Email</strong> is your sender identity. 
                            <strong>SMTP App Passwords</strong> are never stored - provided at runtime.
                        </div>
                    </div>

                    <div class="col-md-6 mb-1">
                        <label class="smallest font-weight-bold text-dark mb-1" for="userSelect">App User (Assignment)</label>
                        <ng-select id="userSelect" name="userId" [(ngModel)]="appData.userId" 
                                   [items]="users" bindLabel="email" bindValue="userId"
                                   placeholder="Select a User..." [clearable]="false" 
                                   class="custom-ng-select-sm" required>
                        </ng-select>
                    </div>

                    <div class="col-md-6 mb-1">
                        <label class="smallest font-weight-bold text-dark mb-1" for="smtpProviderSelect">Email Service Provider</label>
                        <ng-select id="smtpProviderSelect" name="smtpProvider" [(ngModel)]="smtpProvider"
                                   [items]="smtpProviders" bindLabel="label" bindValue="value"
                                   placeholder="Select Email Service Provider..." [clearable]="false"
                                   (change)="onSmtpProviderChange()"
                                   class="custom-ng-select-sm" required>
                        </ng-select>
                        <div class="smallest text-success mt-1" *ngIf="isTPInternal()">
                            <i class="fas fa-shield-alt"></i> Using managed TP SMTP relay (no additional configuration required)
                        </div>
                    </div>

                    <!-- TP Internal Configuration - shown only for TP Internal apps -->
                    <div class="col-12 mb-1" *ngIf="isTPInternal()">
                        <div class="alert alert-success border-0 shadow-sm smallest mb-0 py-2">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>TP Internal Application</strong> - All email configuration is managed by the backend. 
                            No SMTP credentials or server settings required. Emails will be sent via the TP Internal SMTP relay.
                        </div>
                    </div>

                    <!-- TP Internal From Email (Optional) -->
                    <ng-container *ngIf="isTPInternal()">
                        <div class="col-md-6 mb-1">
                            <label class="smallest font-weight-bold text-dark mb-1">From Email (Optional)</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light"><i class="fas fa-envelope"></i></span>
                                <input type="text" name="fromEmailLocalPart" [(ngModel)]="fromEmailLocalPart"
                                       (input)="onFromEmailLocalPartChange()"
                                       class="form-control form-control-sm" placeholder="e.g. support" />
                                <span class="input-group-text bg-light">@</span>
                                <div class="flex-grow-1">
                                    <ng-select name="fromEmailDomain"
                                               [(ngModel)]="fromEmailDomain"
                                               [items]="availableFromEmailDomains"
                                               [addTag]="true"
                                               [addTagText]="'Use this domain'"
                                               (change)="onFromEmailDomainChange()"
                                               placeholder="Select or type domain"
                                               [clearable]="true"
                                               class="custom-ng-select-sm">
                                    </ng-select>
                                </div>
                            </div>
                            <small class="text-muted smallest"><i class="fas fa-info-circle"></i> Suggestions include owner's domain, but you can add any domain</small>
                        </div>
                        <div class="col-md-6 mb-1">
                            <label class="smallest font-weight-bold text-dark mb-1">Display Name (Optional)</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light"><i class="fas fa-signature"></i></span>
                                <input type="text" name="fromEmailDisplayName" [(ngModel)]="appData.fromEmailDisplayName" 
                                       class="form-control form-control-sm" placeholder="e.g. Support Team" />
                            </div>
                        </div>
                    </ng-container>

                    <!-- External App Configuration Fields - hidden for TP Internal -->
                    <ng-container *ngIf="!isTPInternal()">
                        <div class="col-md-6 mb-1">
                            <label class="smallest font-weight-bold text-dark mb-1" for="serviceSelect">Email Service Provider</label>
                            <ng-select id="serviceSelect" name="emailServiceId" [(ngModel)]="appData.emailServiceId"
                                       [items]="emailServices" bindLabel="serviceName" bindValue="id"
                                       placeholder="Select Service..." [clearable]="false" 
                                       class="custom-ng-select-sm" required>
                            </ng-select>
                        </div>

                        <div class="col-md-6 mb-1">
                            <label class="smallest font-weight-bold text-dark mb-1">From Email Address</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light"><i class="fas fa-envelope"></i></span>
                                <input type="email" name="fromEmailAddress" [(ngModel)]="appData.fromEmailAddress" 
                                       class="form-control form-control-sm" placeholder="sender@example.com" required />
                            </div>
                        </div>

                        <div class="col-md-6 mb-1">
                            <label class="smallest font-weight-bold text-dark mb-1">Display Name</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light"><i class="fas fa-signature"></i></span>
                                <input type="text" name="fromEmailDisplayName" [(ngModel)]="appData.fromEmailDisplayName" class="form-control form-control-sm" placeholder="Support Team" required />
                            </div>
                        </div>

                        <!-- Dynamic Server Settings for External Apps -->
                        <ng-container *ngIf="shouldShowServer() || shouldShowPort()">
                            <div class="col-md-6 mb-1" *ngIf="shouldShowServer()">
                                <label class="smallest font-weight-bold text-dark mb-1">SMTP Server</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light"><i class="fas fa-server"></i></span>
                                    <input type="text" name="emailServer" [(ngModel)]="appData.emailServer" 
                                           class="form-control form-control-sm" placeholder="smtp.example.com" required />
                                </div>
                            </div>
                            <div class="col-md-6 mb-1" *ngIf="shouldShowPort()">
                                <label class="smallest font-weight-bold text-dark mb-1">Port Number</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light"><i class="fas fa-plug"></i></span>
                                    <input type="number" name="port" [(ngModel)]="appData.port" 
                                           class="form-control form-control-sm" placeholder="587" required />
                                </div>
                            </div>
                        </ng-container>
                    </ng-container>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" [disabled]="!appForm.form.valid" class="btn btn-primary btn-xs px-3 shadow-sm font-weight-bold">
                            <i class="fas fa-save me-2"></i>{{isEdit ? 'UPDATE' : 'SAVE'}} APPLICATION
                        </button>
                        <button type="button" routerLink="/Admin/Application/List" class="btn btn-link btn-xs text-secondary ms-2">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
